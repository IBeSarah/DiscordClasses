name: Comment Class Diff

on:
  push:
    paths:
      - 'discordclasses.json'

jobs:
  post-diff:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current and previous version of the file
        run: |
          git show HEAD:discordclasses.json > current.json
          git show HEAD^:discordclasses.json > previous.json || echo '{}' > previous.json

      - name: Generate JSON diff
        run: |
          npm install -g json-diff
          json-diff previous.json current.json --color=never > diff.txt || true

      - name: Install GitHub CLI
        run: |
          LATEST_TAG=$(curl --silent "https://api.github.com/repos/cli/cli/releases/latest" | grep -Po '"tag_name": "\K.*?(?=")')
          echo "Latest GH CLI version: $LATEST_TAG"
          wget "https://github.com/cli/cli/releases/download/${LATEST_TAG}/gh_${LATEST_TAG#v}_linux_amd64.deb" -O gh_latest_linux_amd64.deb
          sudo dpkg -i gh_latest_linux_amd64.deb

      - name: Authenticate GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo $GITHUB_TOKEN | gh auth login --with-token

      - name: Split and post comments
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          MAX_SIZE=60000

          awk -v max=$MAX_SIZE '
          BEGIN {buf=""}
          {
            if (length(buf) + length($0) + 1 > max) {
              print buf
              print "---split---"
              buf=""
            }
            buf = buf $0 "\n"
          }
          END {if(buf) print buf}
          ' diff.txt | csplit -f part - '/---split---/' '{*}'

          for file in part*; do
            content=$(cat "$file")
            gh api repos/$GITHUB_REPOSITORY/commits/$GITHUB_SHA/comments -f body="ðŸ§© **Changes in \`discordclasses.json\`:**\n\n\`\`\`diff\n$content\n\`\`\`"
          done
