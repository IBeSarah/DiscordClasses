name: Post JSON module diff

on:
  push:
    branches:
      - main

jobs:
  post-diff:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install Node dependencies
        run: npm install lodash

      - name: Set up JSON files
        run: |
          git show HEAD:discordclasses.json > current.json || echo '{}' > current.json
          git show HEAD^:discordclasses.json > previous.json || echo '{}' > previous.json

      - name: Post structured module diff
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const _ = require('lodash');

            const prev = JSON.parse(fs.readFileSync('previous.json', 'utf8'));
            const curr = JSON.parse(fs.readFileSync('current.json', 'utf8'));

            const MAX_COMMENT_LENGTH = 65536;
            const header = `ðŸ§© **Changes in \`discordclasses.json\`:**\n\n`;

            function compareModules(prevObj, currObj) {
              const sections = [];

              const allModules = _.union(Object.keys(prevObj), Object.keys(currObj));

              allModules.forEach(moduleName => {
                const prevItems = prevObj[moduleName] || [];
                const currItems = currObj[moduleName] || [];

                const removed = _.difference(prevItems, currItems);
                const added = _.difference(currItems, prevItems);

                const renamed = [];
                // naive renamed detection: if an item changed slightly, we could implement heuristics here
                // for now, only exact string changes are detected via removed/added pairs
                // advanced: compare by ID or some property to detect renames

                if (removed.length || added.length || renamed.length) {
                  let section = `### Module: ${moduleName}\n`;
                  if (removed.length) {
                    section += '#### Removed\n';
                    removed.forEach(item => section += `-"${item}"\n`);
                  }
                  if (added.length) {
                    section += '#### Added\n';
                    added.forEach(item => section += `+"${item}"\n`);
                  }
                  if (renamed.length) {
                    section += '#### Renamed\n';
                    renamed.forEach(r => section += `"${r.from}" to "${r.to}"\n`);
                  }
                  sections.push(section);
                }
              });

              return sections.join('\n');
            }

            const diffText = compareModules(prev, curr);
            if (!diffText.trim()) {
              console.log("No changes to post");
              return;
            }

            // Split if too long
            function splitText(text, maxLength) {
              const chunks = [];
              let start = 0;
              while (start < text.length) {
                chunks.push(text.slice(start, start + maxLength));
                start += maxLength;
              }
              return chunks;
            }

            const chunks = splitText(diffText, MAX_COMMENT_LENGTH - header.length);

            for (let i = 0; i < chunks.length; i++) {
              const comment = chunks.length > 1
                ? `${header}**Part ${i + 1} of ${chunks.length}**\n\n${chunks[i]}`
                : `${header}${chunks[i]}`;

              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: comment,
              });

              console.log(`Posted comment part ${i + 1}/${chunks.length}`);
            }
