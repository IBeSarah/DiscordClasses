name: Post Diff Comment

on:
  push:
    paths:
      - 'discordclasses.json'

jobs:
  post-diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # âœ… Ensures HEAD^ is available

      - name: Get current and previous versions of discordclasses.json
        run: |
          echo "Current file content:"
          git show HEAD:discordclasses.json || echo "File not found at HEAD"
          git show HEAD:discordclasses.json > current.json

          echo "Previous file content:"
          git show HEAD^:discordclasses.json > previous.json 2>/dev/null || echo '{}' > previous.json

      - name: Install json-diff
        run: npm install -g json-diff

      - name: Generate diff
        run: |
          json-diff previous.json current.json > diff.txt || true
          echo "----- diff.txt contents -----"
          cat diff.txt

      - name: Comment on commit
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const diff = fs.readFileSync('diff.txt', 'utf8');
            if (!diff.trim()) {
              console.log("No diff to post");
              return;
            }
            const body = `ðŸ§© **Changes in \`discordclasses.json\`:**\n\n\`\`\`diff\n${diff}\n\`\`\``;
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body,
            });
            console.log("Comment posted!");
