name: Comment Class Diff

on:
  push:
    paths:
      - 'discordclasses.json'

jobs:
  post-diff:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current and previous version of the file
        run: |
          git show HEAD:discordclasses.json > current.json
          git show HEAD^:discordclasses.json > previous.json || echo '{}' > previous.json

      - name: Generate JSON diff
        run: |
          npm install -g json-diff
          json-diff previous.json current.json --color=never > diff.txt || true

      - name: Install GitHub CLI
        run: |
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key C99B11DEB97541F0 || true
          sudo apt-add-repository https://cli.github.com/packages || true
          sudo apt update
          sudo apt install -y gh

      - name: Authenticate GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo $GITHUB_TOKEN | gh auth login --with-token

      - name: Split and post comments
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          MAX_SIZE=60000

          # Split diff.txt into chunks smaller than MAX_SIZE, using awk and csplit
          awk -v max=$MAX_SIZE '
          BEGIN {buf=""}
          {
            if (length(buf) + length($0) + 1 > max) {
              print buf
              print "---split---"
              buf=""
            }
            buf = buf $0 "\n"
          }
          END {if(buf) print buf}
          ' diff.txt | csplit -f part - '/---split---/' '{*}'

          # Post each chunk as a separate commit comment
          for file in part*; do
            content=$(cat "$file")
            gh api repos/$GITHUB_REPOSITORY/commits/$GITHUB_SHA/comments -f body="ðŸ§© **Changes in \`discordclasses.json\`:**\n\n\`\`\`diff\n$content\n\`\`\`"
          done
